name: Build and Deploy Ecommerce Locally

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: [self-hosted, wsl, docker]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Write env secrets to files
      run: |
        echo "${{ secrets.BACKEND_ENV_FILE }}" > backend.env
        echo "${{ secrets.FRONTEND_ENV_FILE }}" > frontend.env

    - name: ğŸ“ Place env files where services expect them
      run: |
        # backend expects .env at repo root
        cp backend.env .env

        # frontend expects .env at client/.env
        mkdir -p client
        cp frontend.env client/.env

    - name: ğŸ” Verify Nginx config exists
      run: |
        if [ ! -f nginx/conf.d/default.conf ]; then
          echo "âŒ Nginx config file missing at nginx/conf.d/default.conf"
          exit 1
        else
          echo "âœ… Nginx config found."
        fi

    # ğŸ”¨ IMPORTANT CHANGE HERE:
    # We REMOVED --no-cache so Docker does NOT try to pull base images again.
    - name: ğŸ”¨ Build / Rebuild Docker images (cached)
      run: |
        docker-compose build

    # ğŸš€ Start / recreate stack with new code
    - name: ğŸš€ Recreate and start containers
      run: |
        docker-compose up -d --force-recreate --remove-orphans

    - name: ğŸ“¦ Show running containers
      run: |
        docker ps

    # ğŸ§¹ Cleanup plaintext env files from workspace
    - name: ğŸ§¹ Cleanup env files from disk
      if: always()
      run: |
        rm -f .env client/.env backend.env frontend.env
