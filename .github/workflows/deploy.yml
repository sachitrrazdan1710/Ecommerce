name: Build and Deploy Ecommerce Locally

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: [self-hosted, wsl, docker]

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔐 Write env secrets to files
      run: |
        echo "${{ secrets.BACKEND_ENV_FILE }}" > backend.env
        echo "${{ secrets.FRONTEND_ENV_FILE }}" > frontend.env

    - name: 📁 Place env files where services expect them
      run: |
        # backend expects .env at repo root
        cp backend.env .env

        # frontend expects .env at client/.env
        mkdir -p client
        cp frontend.env client/.env

    - name: 🔍 Verify Nginx config exists
      run: |
        if [ ! -f nginx/conf.d/default.conf ]; then
          echo "❌ Nginx config file missing at nginx/conf.d/default.conf"
          exit 1
        else
          echo "✅ Nginx config found."
        fi

    # 🔨 IMPORTANT CHANGE HERE:
    # We REMOVED --no-cache so Docker does NOT try to pull base images again.
    - name: 🔨 Build / Rebuild Docker images (cached)
      run: |
        docker-compose build

    # 🚀 Start / recreate stack with new code
    - name: 🚀 Recreate and start containers
      run: |
        docker-compose up -d --force-recreate --remove-orphans

    - name: 📦 Show running containers
      run: |
        docker ps

    # 🧹 Cleanup plaintext env files from workspace
    - name: 🧹 Cleanup env files from disk
      if: always()
      run: |
        rm -f .env client/.env backend.env frontend.env
